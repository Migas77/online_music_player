{% extends "layout.html" %} {% block content %} {% load static %} {% load i18n
%}

<div class="overflow-x-auto">
  <table class="table">
    <h1>{{playlist.name}}</h1>
    <hr />
    <thead>
      <tr>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody id="sortable">
      <!-- row 1 -->
      {% for music in musics %}
      <tr class="songitemPlaylist" style="font-size: larger">
        <th style="text-align: center">
          <button class="songlistplay">
            <i
              id="1"
              class="far songItemPlay fa-play-circle"
              data-song-url="{{ music.audio_file.url }}"
            ></i>
          </button>
        </th>
        <td>
          <div class="flex items-center">
            <div class="avatar">
              <div class="mask mask-squircle">
                <img src="{{ music.image.url }}" style="max-width: 150px" />
              </div>
            </div>
          </div>
        </td>
        <td>
          <div class="songName">{{ music.name }}</div>
          <br />
          <span class="badge badge-ghost badge-sm songPerformer"
            >{{music.performer.name}}</span
          >
        </td>
        <td>{{music.genre}}</td>
        <th>
          <button
            class="badge badge-outline btn-error"
            onclick="showModal(this)"
            data-song-name="{{ music.name }}"
            data-song-id="{{ music.id }}"
          >
            <i class="fa fa-trash-o"></i>
          </button>
        </th>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<div class="bottom_tp margin">
  <input type="range" name="range" id="ProgressBar" min="0" max="100" />
  <div class="songinfo-container_tp">
    <div class="songinfo_tp">
      <img
        src="{% static 'images/playing.gif' %}"
        width="45px"
        alt=""
        id="gif"
      />
      <span id="masterSongName"></span>
    </div>
    <div class="icon">
      <i class="fas fa-2x fa-step-backward" id="previous"></i>
      <i class="far fa-2x fa-play-circle" id="masterPlay"></i>
      <i class="fas fa-2x fa-step-forward" id="next"></i>
    </div>
  </div>
</div>

<dialog id="modalDelete" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Remove song from playlist!</h3>
    <p class="py-4"></p>
    <div class="modal-action">
      <input type="hidden" id="globalId" value="" />
      <a class="btn btn-error" id="deleteLink">Yes</a>
      <button
        class="btn"
        onclick="document.getElementById('modalDelete').close()"
      >
        Close
      </button>
    </div>
  </div>
</dialog>
<!-- Jquery -->
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<script>
  let globalName;
  let globalId;
  let playlistId;

  window.showModal = function (button) {
    globalName = button.getAttribute("data-song-name");
    globalId = button.getAttribute("data-song-id");
    document.getElementById("globalId").value = globalId;
    var modalText = document.querySelector("#modalDelete p");
    var modalDelete = document.querySelector("#modalDelete");
    modalText.innerHTML =
      "{% translate 'Are you sure you want to remove from the playlist the following song: ' %}<b>" +
      globalName +
      "</b>?";
    document.getElementById("deleteLink").href =
      "deleteSongPlaylist/" + document.getElementById("globalId").value;

    modalDelete.showModal();
  };
  // SORTABLE
  $( function() {
      let s,from,to;
      let isDraggeable = true;
      s = $( "#sortable" );
      s.sortable({revert: true});
      s.on("sortstart",function(event,ui){
          from = ui.item.index();
      });
      $('#sortable').on('sortdeactivate',function(event,ui) {
          to = ui.item.index();
          if (isDraggeable){
              isDraggeable = false
              // disable draggeable until getting response from server
              $.ajax({
                url: '{% url "sortPlaylist" %}',
                data: {
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                    prev_position: from,
                    next_position: to,
                    playlist_id: {{ playlist.id }}
                },
              method: "POST",
              success: function (response) {
                console.log(response.success)
              },
            });
          }
      });

  } );
</script>

{% endblock %}
